<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Run a go service · opctl</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="We&#x27;ll now look at an op to run a sample Go application. Please see the code at [https://github.com/opctl/opctl/tree/master/examples/run-a-go-service](https://github.com/opctl/opctl/tree/master/examples/run-a-go-service)"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Run a go service · opctl"/><meta property="og:type" content="website"/><meta property="og:url" content="https://opctl.io/"/><meta property="og:description" content="We&#x27;ll now look at an op to run a sample Go application. Please see the code at [https://github.com/opctl/opctl/tree/master/examples/run-a-go-service](https://github.com/opctl/opctl/tree/master/examples/run-a-go-service)"/><meta property="og:image" content="https://opctl.io/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://opctl.io/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/img/logo.svg"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.svg" alt="opctl"/><h2 class="headerTitleWithLogo">opctl</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/setup" target="_self">Docs</a></li><li class="siteNavGroupActive"><a href="/docs/run-a-react-app" target="_self">Examples</a></li><li class=""><a href="https://github.com/opctl/opctl" target="_self">GitHub</a></li><li class=""><a href="https://opctl-slackin.herokuapp.com" target="_self">Slack</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Portable Dev</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Portable Dev</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/run-a-react-app">run a react app</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/run-a-go-service">run a go service</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/opctl/opctl/edit/master/docs/run-a-go-service.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 class="postHeaderTitle">Run a go service</h1></header><article><div><span><p>We'll now look at an op to run a sample Go application. Please see the code at <a href="https://github.com/opctl/opctl/tree/master/examples/run-a-go-service">https://github.com/opctl/opctl/tree/master/examples/run-a-go-service</a>
The sample application we have requires a mysql database, therefore to run it locally we need to:</p>
<ol>
<li>Start a MySQL database with some DB credentials</li>
<li>(optional) Seed the DB with sample data</li>
<li>Start the application and provide the MySQL DB credentials as inputs - our application will read those from environment variables</li>
</ol>
<p>The ops to make that happen are explained below.</p>
<h4><a class="anchor" aria-hidden="true" id="mysql"></a><a href="#mysql" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>mysql</h4>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">runs</span> <span class="hljs-string">a</span> <span class="hljs-string">mysql</span> <span class="hljs-string">container,</span> <span class="hljs-string">optionally</span> <span class="hljs-string">seeding</span> <span class="hljs-string">it</span> <span class="hljs-string">with</span> <span class="hljs-string">sample</span> <span class="hljs-string">data</span>
<span class="hljs-attr">inputs:</span>
<span class="hljs-attr">  MYSQL_USER:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testuser</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">username</span> <span class="hljs-string">for</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">user</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_PASSWORD:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testpassword</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">password</span> <span class="hljs-string">for</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">user</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_DATABASE:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testapp</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">Database</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_HOST:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">mysql</span>
<span class="hljs-attr">  doSeed:</span>
<span class="hljs-attr">    boolean:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-literal">false</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">if</span> <span class="hljs-literal">true</span><span class="hljs-string">,</span> <span class="hljs-string">sample</span> <span class="hljs-string">data</span> <span class="hljs-string">will</span> <span class="hljs-string">be</span> <span class="hljs-string">inserted</span> <span class="hljs-string">in</span> <span class="hljs-string">the</span> <span class="hljs-string">database</span>
<span class="hljs-attr">run:</span>
<span class="hljs-attr">  parallel:</span>
<span class="hljs-attr">    - container:</span>
<span class="hljs-attr">        image:</span> <span class="hljs-string">{</span> <span class="hljs-attr">ref:</span> <span class="hljs-string">'mysql:8'</span> <span class="hljs-string">}</span>
<span class="hljs-attr">        name:</span> <span class="hljs-string">mysql</span> <span class="hljs-comment"># this value will be provided as input to the 'local' op so our code knows what mysql host to connect to</span>
<span class="hljs-attr">        envVars:</span> <span class="hljs-string">{MYSQL_USER</span> <span class="hljs-string">,</span> <span class="hljs-string">MYSQL_PASSWORD</span> <span class="hljs-string">,</span> <span class="hljs-string">MYSQL_DATABASE</span> <span class="hljs-string">,</span> <span class="hljs-attr">MYSQL_RANDOM_ROOT_PASSWORD:</span> <span class="hljs-string">"yes"</span><span class="hljs-string">}</span>
<span class="hljs-attr">        ports:</span> <span class="hljs-string">{</span> <span class="hljs-string">'3306'</span><span class="hljs-string">:</span> <span class="hljs-string">'3306'</span> <span class="hljs-string">}</span>
<span class="hljs-attr">    - container:</span>
<span class="hljs-attr">        image:</span> <span class="hljs-string">{</span> <span class="hljs-attr">ref:</span> <span class="hljs-string">'mysql:8'</span> <span class="hljs-string">}</span>
<span class="hljs-attr">        envVars:</span> <span class="hljs-string">{MYSQL_USER,</span> <span class="hljs-string">MYSQL_PASSWORD,</span> <span class="hljs-string">MYSQL_HOST,</span> <span class="hljs-string">MYSQL_DATABASE,</span> <span class="hljs-string">doSeed}</span>
<span class="hljs-attr">        files:</span>
          <span class="hljs-string">/seed.sql:</span> <span class="hljs-comment"># this shorthand form will copy seed.sql from the root of this op to the root of the container</span>
<span class="hljs-attr">        workDir:</span> <span class="hljs-string">/db</span>
<span class="hljs-attr">        cmd:</span> 
<span class="hljs-bullet">          -</span> <span class="hljs-string">sh</span>
<span class="hljs-bullet">          -</span> <span class="hljs-bullet">-ce</span>
<span class="hljs-bullet">          -</span> <span class="hljs-string">|
            echo "starting seed script"
            sleep 25 # we'll sleep while the MySQL DB starts
            if [ $doSeed = "true" ]
            then
              echo "connecting to load sql script"
              mysql -u $MYSQL_USER -p$MYSQL_PASSWORD -h $MYSQL_HOST $MYSQL_DATABASE &lt; /seed.sql
            fi
            exit 0
</span></code></pre>
<p>This op will run a MySQL database in a Docker container. It has an optional input, <code>doSeed</code>, which is of type <code>Boolean</code>. When <code>true</code>, it will run the <code>seed.sql</code> script in a second, parallel container to seed the MySQL database in first container with a single table and a single row of data.</p>
<p>Note that instead of writing the <code>cmd</code> inline, we could have also put the run script in a file in the op directory and referenced it.
e.g.</p>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">cmd:</span> <span class="hljs-string">["/run.sh"]</span>
</code></pre>
<p>This becomes useful for readability if the script we're running in a container is large.</p>
<p>Note that while we could have also built a custom docker image that contains that script and ran it, that's not a recommended practice. While the op remains portable with that approach, it is less transparent and harder to maintain, since we would have the extra step of building and pushing that image whenever we make a change to the script. Instead, we usually opt for the leanest Docker image that fulfills our use case, and include any scripts or binaries we need in the op directory.</p>
<h4><a class="anchor" aria-hidden="true" id="dev"></a><a href="#dev" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>dev</h4>
<pre><code class="hljs css language-yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">dev</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">runs</span> <span class="hljs-string">go-svc</span> <span class="hljs-string">for</span> <span class="hljs-string">development</span>
<span class="hljs-attr">inputs:</span>
<span class="hljs-attr">  MYSQL_USER:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testuser</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">username</span> <span class="hljs-string">for</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">user</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_PASSWORD:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testpassword</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">password</span> <span class="hljs-string">for</span> <span class="hljs-string">MySQL</span> <span class="hljs-string">user</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_DATABASE:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">testapp</span>
<span class="hljs-attr">      description:</span> <span class="hljs-string">Database</span> <span class="hljs-string">to</span> <span class="hljs-string">create</span>
<span class="hljs-attr">  MYSQL_HOST:</span>
<span class="hljs-attr">    string:</span>
<span class="hljs-attr">      default:</span> <span class="hljs-string">mysql</span> <span class="hljs-comment"># the host for mysql is the container name in the mysql op</span>
<span class="hljs-attr">run:</span>
<span class="hljs-attr">  parallel:</span>
<span class="hljs-attr">    - op:</span>
<span class="hljs-attr">        ref:</span> <span class="hljs-string">../mysql</span> <span class="hljs-comment"># we reference the mysql op using its relative path to this op</span>
<span class="hljs-attr">        inputs:</span> <span class="hljs-string">{</span> <span class="hljs-string">MYSQL_USER,</span> <span class="hljs-string">MYSQL_PASSWORD,</span> <span class="hljs-string">MYSQL_HOST,</span> <span class="hljs-string">MYSQL_DATABASE,</span> <span class="hljs-attr">doSeed:</span> <span class="hljs-literal">true</span><span class="hljs-string">}</span> <span class="hljs-comment"># we pass the relevant inputs through to the mysql op</span>
<span class="hljs-attr">    - container:</span>
<span class="hljs-attr">        image:</span> <span class="hljs-string">{</span> <span class="hljs-attr">ref:</span> <span class="hljs-string">'golang:1.10.3'</span> <span class="hljs-string">}</span>
<span class="hljs-attr">        name:</span> <span class="hljs-string">go-svc</span>
<span class="hljs-attr">        dirs:</span>
          <span class="hljs-string">/go/src/github.com/golang-ops-example:</span> <span class="hljs-string">$(/app)</span> <span class="hljs-comment"># IMPORTANT: we've created a symlink in the root of the op (i.e. at /.opspec/dev) to the source code of our app (i.e. at /app) - this is so we can encapsulate the op, meaning that any files the op needs to reference now are accessible from within its directory. we reference that symlink here as /app because that refers to the root of the op - see https://opctl.io/docs/reference/op-definition-format/op.yml/expressions/dir-entry-ref.html#embedded-json-file for more details</span>
<span class="hljs-attr">        envVars:</span> <span class="hljs-string">{MYSQL_USER,</span> <span class="hljs-string">MYSQL_PASSWORD,</span> <span class="hljs-string">MYSQL_HOST,</span> <span class="hljs-string">MYSQL_DATABASE}</span> <span class="hljs-comment"># the same inputs are needed to let our code know how to connect to the DB</span>
<span class="hljs-attr">        workDir:</span> <span class="hljs-string">/go/src/github.com/golang-ops-example</span>
<span class="hljs-attr">        ports:</span> <span class="hljs-string">{</span> <span class="hljs-string">'8080'</span><span class="hljs-string">:</span> <span class="hljs-string">'8080'</span> <span class="hljs-string">}</span>
<span class="hljs-attr">        cmd:</span>
<span class="hljs-bullet">          -</span> <span class="hljs-string">sh</span>
<span class="hljs-bullet">          -</span> <span class="hljs-bullet">-ce</span>
<span class="hljs-bullet">          -</span> <span class="hljs-string">|
            go get -u github.com/cespare/reflex # get reflex to watch and hot-reload our main.go
            sleep 30 # we'll sleep while the MySQL DB starts
            /go/bin/reflex -g 'main.go' -s -- sh -c 'go run main.go'
</span></code></pre>
<p>This op will do the following, in parallel:</p>
<ol>
<li>Run the mysql op, passing in the inputs needed to create it</li>
<li>run our service in the <code>golang</code> container. We'll use <a href="https://github.com/cespare/reflex">reflex</a> to make development easier and avoid having to restart the whole operation after every change to main.go</li>
</ol>
<p>Now to run the service locally, we only run <code>opctl run dev</code></p>
<p>Notice how we can run ops in a <code>parallel</code> block. Our app runs parallel to the MySQL DB container (via the <code>mysql</code> op), because we need mysql running while our app runs.</p>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 7/9/2019 by Chris Dostert</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/run-a-react-app"><span class="arrow-prev">← </span><span>run a react app</span></a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.svg" alt="opctl" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/en/setup.html">Beginner Guides</a><a href="/docs/en/opspec.html">Opspec Reference</a><a href="/docs/en/interop-azure-pipelines.html">Interop</a></div><div><h5>Community</h5><a href="https://opctl-slackin.herokuapp.com">Slack</a></div><div><h5>More</h5><a href="https://github.com/opctl/opctl">GitHub</a><a class="github-button" href="https://github.com/opctl/opctl" data-icon="octicon-star" data-count-href="/opctl/opctl/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2019 opctl</section></footer></div></body></html>
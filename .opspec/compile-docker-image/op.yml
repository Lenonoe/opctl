name: compile-docker-image
description: compiles a docker image and stores it in the local registry
inputs:
  dockerDSocket:
    socket:
      description: socket for docker daemon
  version:
    string:
      constraints: { format: semver }
      description: version of opctl being compiled
outputs:
  dockerImageRef:
    string:
      constraints: { format: docker-image-ref }
      description: docker image reference
run:
  container:
    cmd:
      - sh
      - -ce
      - |
        echo "determining channel"
        case "$(version)" in
          *beta*)
            channel=beta
            ;;
          *alpha*)
            channel=alpha
            ;;
          *)
            channel=stable
            ;;
        esac

        dockerImageRef=opctl/opctl:"$channel"

        echo dockerImageRef=$dockerImageRef

        echo "compiling image"
        docker build --build-arg CHANNEL="$channel" --no-cache -t "$dockerImageRef" .
    dirs:
      /workDir: /
    image: { ref: 'docker:17.07.0-dind' }
    sockets:
      /var/run/docker.sock: dockerDSocket
    stdOut:
      dockerImageRef=: dockerImageRef
    workDir: /workDir

description: Runs all ops necessary to build & deploy the spec
name: deploy
inputs:
  srcDir:
    dir:
      default: .
      description: dir containing the doc source
  awsAccessKeyId:
    string:
      constraints: { minLength: 20 }
      description: access key for AWS
  awsSecretAccessKey:
    string:
      constraints: { minLength: 20 }
      description: secret access key for AWS
      isSecret: true
  version:
    string:
      constraints: { format: semver }
      description: version of the spec being deployed
run:
  serial:
    - op:
        pkg: { ref: build }
        inputs: { srcDir }
        outputs: { srcDir }
    - container:
        cmd:
          - sh
          - -ce
          - |
            echo "installing deps"
            pip install awscli

            echo "deploy"
            aws s3 sync . s3://opspec.io --delete

            echo "archive"
            aws s3 sync . s3://archive.opspec.io/$(version) --delete
        dirs:
          /src: srcDir
        envVars:
          AWS_ACCESS_KEY_ID: $(awsAccessKeyId)
          AWS_SECRET_ACCESS_KEY: $(awsSecretAccessKey)
          AWS_DEFAULT_REGION: us-west-2
        image: { ref: 'python:2.7' }
        workDir: /src/build
